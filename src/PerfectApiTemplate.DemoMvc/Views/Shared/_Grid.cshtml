@model GridViewModel<object>
@{
    string BuildSortUrl(string sortKey, bool isCurrent, string? currentDir)
    {
        var values = new Dictionary<string, string?>(Model.QueryOptions.Query, StringComparer.OrdinalIgnoreCase)
        {
            ["OrderBy"] = sortKey,
            ["OrderDir"] = isCurrent && string.Equals(currentDir, "asc", StringComparison.OrdinalIgnoreCase) ? "desc" : "asc",
            ["PageNumber"] = "1",
            ["PageSize"] = Model.QueryOptions.PageSize.ToString()
        };
        return Url.Action(Model.QueryOptions.Action, Model.QueryOptions.Controller, values) ?? "#";
    }
}

<div class="@Model.CardCssClass">
    <div class="card-header d-flex align-items-center justify-content-between">
        <div>
            <h5 class="mb-0">@Model.Title</h5>
            @if (!string.IsNullOrWhiteSpace(Model.Subtitle))
            {
                <small class="text-muted">@Model.Subtitle</small>
            }
        </div>
        @if (!string.IsNullOrWhiteSpace(Model.PrimaryActionText) && !string.IsNullOrWhiteSpace(Model.PrimaryActionUrl))
        {
            <a class="btn btn-primary" href="@Model.PrimaryActionUrl">
                <i class="bi bi-plus-lg me-1"></i>@Model.PrimaryActionText
            </a>
        }
    </div>

    <div class="table-responsive">
        <table class="@Model.TableCssClass">
            <thead>
                <tr>
                    @foreach (var column in Model.Columns)
                    {
                        var isCurrent = string.Equals(Model.QueryOptions.OrderBy, column.SortKey, StringComparison.OrdinalIgnoreCase);
                        var sortUrl = column.IsSortable ? BuildSortUrl(column.SortKey!, isCurrent, Model.QueryOptions.OrderDir) : null;
                        var sortDir = isCurrent ? (Model.QueryOptions.OrderDir?.ToLowerInvariant() == "asc" ? "asc" : "desc") : string.Empty;
                        <th class="@column.HeaderCssClass @(column.IsSortable ? "sortable" : string.Empty)">
                            @if (column.IsSortable)
                            {
                                <a class="sort-link @sortDir" href="@sortUrl">
                                    @column.Header
                                    <i class="bi bi-arrow-down-up ms-1"></i>
                                </a>
                            }
                            else
                            {
                                @column.Header
                            }
                        </th>
                    }
                    @if (Model.RowActions.Count > 0)
                    {
                        <th class="text-end">Actions</th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (Model.Items.Count == 0)
                {
                    <tr>
                        <td colspan="@(Model.Columns.Count + (Model.RowActions.Count > 0 ? 1 : 0))">
                            <div class="empty-state">@Model.EmptyMessage</div>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in Model.Items)
                    {
                        <tr>
                            @foreach (var column in Model.Columns)
                            {
                                <td class="@column.CellCssClass">
                                    @column.Cell(item)
                                </td>
                            }
                            @if (Model.RowActions.Count > 0)
                            {
                                <td class="text-end">
                                    @foreach (var action in Model.RowActions)
                                    {
                                        var url = action.Url(item);
                                        if (!string.IsNullOrWhiteSpace(url))
                                        {
                                            <a class="@action.CssClass" href="@url">
                                                @if (!string.IsNullOrWhiteSpace(action.IconClass))
                                                {
                                                    <i class="@action.IconClass me-1"></i>
                                                }
                                                @action.Text
                                            </a>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted small">
            Page @Model.Pagination.PageNumber of @Model.Pagination.TotalPages
        </div>
        <partial name="_Pagination" model="Model.Pagination" />
    </div>
</div>
