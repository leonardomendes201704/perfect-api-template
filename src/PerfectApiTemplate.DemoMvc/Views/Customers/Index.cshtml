@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Html
@model CustomerListViewModel
@{
    ViewData["Title"] = "Customers";
    ViewData["Subtitle"] = "Manage customer records with pagination and filters";

    var grid = new GridViewModel<object>
    {
        Title = "Customers",
        Subtitle = $"Total: {Model.Pagination.TotalCount}",
        PrimaryActionText = "New Customer",
        PrimaryActionUrl = Url.Action("Create", "Customers"),
        Items = Model.Items.Cast<object>().ToList(),
        Pagination = Model.Pagination,
        QueryOptions = new GridQueryOptions
        {
            Action = "Index",
            Controller = "Customers",
            OrderBy = Model.Query.OrderBy,
            OrderDir = Model.Query.OrderDir,
            PageSize = Model.Query.PageSize,
            Query = new Dictionary<string, string?>
            {
                ["Search"] = Model.Query.Search,
                ["Email"] = Model.Query.Email,
                ["Name"] = Model.Query.Name,
                ["IncludeInactive"] = Model.Query.IncludeInactive.ToString(),
                ["PageSize"] = Model.Query.PageSize.ToString()
            }
        },
        Columns = new List<GridColumn<object>>
        {
            new()
            {
                Header = "Name",
                SortKey = "Name",
                Cell = item => new HtmlString(HtmlEncoder.Default.Encode(((CustomerDto)item).Name))
            },
            new()
            {
                Header = "Email",
                SortKey = "Email",
                Cell = item => new HtmlString(HtmlEncoder.Default.Encode(((CustomerDto)item).Email))
            },
            new()
            {
                Header = "Date of Birth",
                SortKey = "DateOfBirth",
                Cell = item => new HtmlString(((CustomerDto)item).DateOfBirth.ToString("yyyy-MM-dd"))
            },
            new()
            {
                Header = "Created",
                SortKey = "CreatedAtUtc",
                Cell = item => new HtmlString(((CustomerDto)item).CreatedAtUtc.ToLocalTime().ToString("g"))
            }
        },
        RowActions = new List<GridRowAction<object>>
        {
            new()
            {
                Text = "Details",
                CssClass = "btn btn-sm btn-outline-secondary",
                Url = item => Url.Action("Details", "Customers", new { id = ((CustomerDto)item).Id })
            },
            new()
            {
                Text = "Edit",
                CssClass = "btn btn-sm btn-outline-primary",
                Url = item => Url.Action("Edit", "Customers", new { id = ((CustomerDto)item).Id })
            },
            new()
            {
                Text = "Delete",
                CssClass = "btn btn-sm btn-outline-danger",
                Url = item => Url.Action("Delete", "Customers", new { id = ((CustomerDto)item).Id })
            }
        },
        Filters = new GridFilterViewModel
        {
            Action = "Index",
            Controller = "Customers",
            Fields = new List<GridFilterField>
            {
                new()
                {
                    Name = "OrderBy",
                    Value = Model.Query.OrderBy,
                    IsHidden = true
                },
                new()
                {
                    Name = "OrderDir",
                    Value = Model.Query.OrderDir,
                    IsHidden = true
                },
                new()
                {
                    Label = "Search",
                    Name = "Search",
                    Value = Model.Query.Search,
                    Placeholder = "Name or email"
                },
                new()
                {
                    Label = "Email",
                    Name = "Email",
                    Value = Model.Query.Email
                },
                new()
                {
                    Label = "Name",
                    Name = "Name",
                    Value = Model.Query.Name
                },
                new()
                {
                    Label = "Page Size",
                    Name = "PageSize",
                    Type = GridFilterType.Select,
                    Options = new List<GridSelectOption>
                    {
                        new() { Value = "10", Text = "10", Selected = Model.Query.PageSize == 10 },
                        new() { Value = "25", Text = "25", Selected = Model.Query.PageSize == 25 },
                        new() { Value = "50", Text = "50", Selected = Model.Query.PageSize == 50 }
                    }
                }
            },
            ShowReset = true,
            ResetUrl = Url.Action("Index", "Customers")
        }
    };
}

@if (grid.Filters is not null)
{
    <partial name="_GridFilters" model="grid.Filters" />
}

<partial name="_Grid" model="grid" />
