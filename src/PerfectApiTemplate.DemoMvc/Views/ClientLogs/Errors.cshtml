@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Html
@inject PerfectApiTemplate.DemoMvc.Infrastructure.ApiUrlProvider ApiUrlProvider
@model PerfectApiTemplate.DemoMvc.ViewModels.Logs.ClientErrorLogsViewModel
@{
    ViewData["Title"] = "Frontend Errors";
    ViewData["Subtitle"] = "Client-side telemetry events from Demo MVC";

    var signalrOptions = new PerfectApiTemplate.DemoMvc.ViewModels.Shared.SignalRLogOptions
    {
        ApiBaseUrl = ApiUrlProvider.GetBaseUrl(),
        Channel = "logs.errors",
        EventName = "errorLog.created",
        ReloadMessage = "New frontend error received. Refreshing...",
        ToggleStorageKey = "signalr.autorefresh.clienterrors"
    };

    var queryOptions = new GridQueryOptions
    {
        Action = "Errors",
        Controller = "ClientLogs",
        OrderBy = Model.Filters.OrderBy,
        OrderDir = Model.Filters.OrderDir,
        PageSize = Model.Filters.PageSize,
        Query = new Dictionary<string, string?>
        {
            ["EventType"] = Model.Filters.EventType,
            ["Severity"] = Model.Filters.Severity,
            ["FromUtc"] = Model.Filters.FromUtc?.ToString("O"),
            ["ToUtc"] = Model.Filters.ToUtc?.ToString("O"),
            ["PageSize"] = Model.Filters.PageSize.ToString()
        }
    };

    var filters = new GridFilterViewModel
    {
        Action = "Errors",
        Controller = "ClientLogs",
        Fields = new List<GridFilterField>
        {
            new() { Name = "OrderBy", Value = Model.Filters.OrderBy, IsHidden = true },
            new() { Name = "OrderDir", Value = Model.Filters.OrderDir, IsHidden = true },
            new() { Label = "Event type", Name = "EventType", Value = Model.Filters.EventType },
            new()
            {
                Label = "Severity",
                Name = "Severity",
                Type = GridFilterType.Select,
                Options = new List<GridSelectOption>
                {
                    new() { Value = "", Text = "Any", Selected = string.IsNullOrWhiteSpace(Model.Filters.Severity) },
                    new() { Value = "info", Text = "Info", Selected = Model.Filters.Severity == "info" },
                    new() { Value = "warning", Text = "Warning", Selected = Model.Filters.Severity == "warning" },
                    new() { Value = "error", Text = "Error", Selected = Model.Filters.Severity == "error" },
                    new() { Value = "critical", Text = "Critical", Selected = Model.Filters.Severity == "critical" }
                }
            },
            new() { Label = "From (UTC)", Name = "FromUtc", Type = GridFilterType.Date, Value = Model.Filters.FromUtc?.ToString("yyyy-MM-dd") },
            new() { Label = "To (UTC)", Name = "ToUtc", Type = GridFilterType.Date, Value = Model.Filters.ToUtc?.ToString("yyyy-MM-dd") },
            new()
            {
                Label = "Page Size",
                Name = "PageSize",
                Type = GridFilterType.Select,
                Options = new List<GridSelectOption>
                {
                    new() { Value = "10", Text = "10", Selected = Model.Filters.PageSize == 10 },
                    new() { Value = "25", Text = "25", Selected = Model.Filters.PageSize == 25 },
                    new() { Value = "50", Text = "50", Selected = Model.Filters.PageSize == 50 }
                }
            }
        },
        ShowReset = true,
        ResetUrl = Url.Action("Errors", "ClientLogs")
    };

    var filterDrawer = new FilterDrawerViewModel
    {
        Id = "clientErrorFilters",
        Title = "Frontend error filters",
        Filters = filters,
        ButtonText = "Filters"
    };

    var grid = new GridBuilder<ErrorLogDto>()
        .WithTitle("Frontend Errors")
        .WithSubtitle($"Total: {Model.Pagination.TotalCount}")
        .WithItems(Model.Items)
        .WithPagination(Model.Pagination)
        .WithQueryOptions(queryOptions)
        .WithFilters(filters)
        .AddColumn("Time", item => new HtmlString(item.CreatedAtUtc.ToLocalTime().ToString("g")), "CreatedAtUtc")
        .AddColumn("Event", item =>
        {
            var value = string.IsNullOrWhiteSpace(item.EventType) ? item.ExceptionType : item.EventType;
            return new HtmlString(HtmlEncoder.Default.Encode(value));
        }, "EventType")
        .AddColumn("Severity", item => new HtmlString(HtmlEncoder.Default.Encode(item.Severity ?? "-")), "Severity")
        .AddColumn("Status", item =>
        {
            var status = item.ApiStatusCode ?? item.StatusCode;
            return new HtmlString(status?.ToString() ?? "-");
        }, "StatusCode")
        .AddColumn("Message", item =>
        {
            var message = HtmlEncoder.Default.Encode(item.Message);
            return new HtmlString($"<span class=\"text-truncate d-inline-block\" style=\"max-width: 260px;\">{message}</span>");
        }, "Message")
        .AddAction("Details", item => Url.Action("Error", "ClientLogs", new { id = item.Id }))
        .Build();
}

<partial name="_FilterDrawer" model="filterDrawer" />
<partial name="_Grid" model="grid" />
<div class="mt-3">
    <div class="d-flex align-items-center gap-2">
        <span class="badge text-bg-secondary" data-signalr-status>SignalR: disconnected</span>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="autoRefreshClientErrors" data-signalr-toggle>
            <label class="form-check-label" for="autoRefreshClientErrors">Auto-refresh</label>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_SignalRLogs" model="signalrOptions" />
}
